# Enhanced Delphi LightRAG Features

## 新機能

### 1. 文字コード自動判定（Shift-JIS対応）
- `chardet`ライブラリを使用して文字コードを自動検出
- Shift-JIS、UTF-8、その他のエンコーディングに対応
- 日本語コメントを含むDelphiコードも正しく処理可能

### 2. ディレクトリ一括処理
- 指定ディレクトリ配下のすべての.pasと.dfmファイルを再帰的に検索
- サブディレクトリも自動的に処理
- 除外ディレクトリ（.git、__pycache__など）の自動スキップ

### 3. 進捗管理と再開機能
- `.lightrag_progress.json`ファイルで処理状況を記録
- 中断後も前回の続きから処理を再開可能
- `--reset`オプションで進捗をリセット
- `--no-resume`オプションで再開機能を無効化

### 4. トークン制限対応
- text-embedding-3-largeの8,191トークン制限を考慮
- 大きなファイルは自動的にチャンク分割
- AST情報を活用したインテリジェントなチャンク分割
- 関数・クラス単位での論理的な分割

### 5. 自動生成ファイルの検出
- ファイル名パターン（.designer.pas、.generated.pasなど）
- コンテンツパターン（"auto-generated"、"do not edit"など）
- 自動生成ファイルは自動的にスキップ

## 使用方法

### 基本的な使用方法
```bash
python process_delphi_code_enhanced.py /path/to/delphi/project
```

### オプション
- `--reset`: 進捗をリセットして最初から処理
- `--no-resume`: 前回の進捗を無視して処理
- `--progress-file`: カスタム進捗ファイルのパス指定

### テスト実行
```bash
# 拡張機能のテスト
./run_enhanced_test.sh

# または直接実行
python test_enhanced_processor.py
```

## 処理フロー

1. **ファイル検索**: 指定ディレクトリ配下の.pas/.dfmファイルを検索
2. **進捗チェック**: 既に処理済みのファイルをスキップ
3. **文字コード検出**: chardetで自動検出、必要に応じてShift-JISで読み込み
4. **自動生成チェック**: 自動生成ファイルを検出してスキップ
5. **AST分析**: tree-sitter-pascalで構文解析（.pasファイルのみ）
6. **チャンク分割**: トークン制限を考慮して適切に分割
7. **LightRAG登録**: REST API経由でベクトルDBに登録
8. **進捗更新**: 処理完了したファイルを記録

## 統計情報

処理完了後、以下の統計情報が表示されます：
- 総ファイル数
- 処理済みファイル数
- スキップされたファイル数
- 失敗したファイル数
- 自動生成ファイル数
- 作成されたチャンク数
- ファイルあたりの平均チャンク数